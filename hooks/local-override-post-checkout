#!/usr/bin/env bash
#
# local-override-post-checkout
#
# Applies local overrides to the working tree after checkout operations.
# Called by git after: checkout, switch, clone, pull (with checkout)
#
# This hook reads .local-overrides.yaml from the repo root and applies
# override files to their target files.
#
# Arguments (from git):
#   $1 - Previous HEAD ref
#   $2 - New HEAD ref
#   $3 - Flag: 1 if checkout was a branch checkout, 0 if file checkout
#
# Performance target: <50ms for 10 overrides
#
set -euo pipefail

# Find the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source the shared library
# shellcheck source=local-override-lib.sh
source "$SCRIPT_DIR/local-override-lib.sh"

main() {
    # Only apply on branch checkouts (3rd arg = 1), not file checkouts (3rd arg = 0)
    # This allows `git checkout HEAD -- file` to work for restoring originals
    local is_branch_checkout="${3:-1}"
    if [[ "$is_branch_checkout" == "0" ]]; then
        exit 0
    fi

    local repo_root
    repo_root="$(get_repo_root)" || exit 0

    # Quick exit if no config file
    if [[ ! -f "$repo_root/.local-overrides.yaml" ]]; then
        exit 0
    fi

    # Validate config
    if ! validate_config "$repo_root"; then
        exit 1
    fi

    # Apply each override
    local entry target override
    while IFS= read -r entry || [[ -n "$entry" ]]; do
        [[ -z "$entry" ]] && continue

        # Parse entry: "target|override"
        target="${entry%%|*}"
        override="${entry#*|}"

        local full_target="$repo_root/$target"
        local full_override="$repo_root/$override"

        # Check if both target and override files exist
        if [[ -f "$full_override" && -f "$full_target" ]]; then
            # Apply override: copy override content to target file
            cp "$full_override" "$full_target"
            # Mark as skip-worktree so git status doesn't show the change
            git -C "$repo_root" update-index --skip-worktree "$target" 2>/dev/null || true
        fi
    done < <(read_config "$repo_root")

    exit 0
}

main "$@"
