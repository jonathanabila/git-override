#!/usr/bin/env bash
#
# local-override-post-commit
#
# Re-applies local overrides after a commit completes.
# This restores your local content that was temporarily replaced during commit.
#
# This hook reads .local-overrides.yaml from the repo root and re-applies
# any local overrides after the commit.
#
# Performance target: <50ms
#
set -euo pipefail

# Find the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source the shared library
# shellcheck source=local-override-lib.sh
source "$SCRIPT_DIR/local-override-lib.sh"

main() {
    local repo_root
    repo_root="$(get_repo_root)" || exit 0

    # Quick exit if no config file
    if [[ ! -f "$repo_root/.local-overrides.yaml" ]]; then
        exit 0
    fi

    # Validate config
    if ! validate_config "$repo_root"; then
        exit 1
    fi

    # Re-apply each override (same logic as post-checkout)
    local entry target override
    while IFS= read -r entry || [[ -n "$entry" ]]; do
        [[ -z "$entry" ]] && continue

        # Parse entry: "target|override"
        target="${entry%%|*}"
        override="${entry#*|}"

        local full_target="$repo_root/$target"
        local full_override="$repo_root/$override"

        # Check if both target and override files exist
        if [[ -f "$full_override" && -f "$full_target" ]]; then
            # Apply override: copy override content to target file
            cp "$full_override" "$full_target"
        fi
    done < <(read_config "$repo_root")

    exit 0
}

main "$@"
