#!/usr/bin/env bash
#
# git-local-override - Utility for managing local file overrides
#
# This tool helps manage local modifications to tracked files.
# Configuration is stored in .local-overrides.yaml in your repository.
#
# The main functionality is provided by git hooks (installed separately).
# This CLI provides utility commands for managing override files.
#
# WHY CLI IS SEPARATE FROM HOOKS:
# The CLI is optional - hooks work independently. This allows users who only
# need basic functionality to skip CLI installation entirely. The CLI adds
# convenience commands (add, remove, list, status) but isn't required.
#
# NOTE ON CODE DUPLICATION:
# read_config() is duplicated from local-override-lib.sh.
# This is intentional: the CLI must work standalone without the hooks installed,
# so it cannot source the lib file (which lives in .git/hooks/).
#
set -euo pipefail

# Colors for output (if terminal supports it)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

#------------------------------------------------------------------------------
# Utility Functions
#------------------------------------------------------------------------------

die() {
    echo -e "${RED}Error:${NC} $*" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}Warning:${NC} $*" >&2
}

info() {
    echo -e "${BLUE}Info:${NC} $*"
}

success() {
    echo -e "${GREEN}Success:${NC} $*"
}

# Get the root directory of the current git repository
get_repo_root() {
    git rev-parse --show-toplevel 2>/dev/null || die "Not in a git repository"
}

# Read the pattern field from config file
# Returns the pattern string, or empty if not found
read_pattern() {
    local repo_root="$1"
    local config_file="$repo_root/.local-overrides.yaml"

    [[ -f "$config_file" ]] || return 0

    local line
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip empty lines and comments
        [[ -z "$line" || "$line" == \#* ]] && continue
        # Match pattern: "pattern: .something" or 'pattern: ".something"'
        if [[ "$line" =~ ^pattern:[[:space:]]*(.+)$ ]]; then
            local pattern="${BASH_REMATCH[1]}"
            # Remove quotes if present
            pattern="${pattern#\"}"
            pattern="${pattern%\"}"
            pattern="${pattern#\'}"
            pattern="${pattern%\'}"
            # Trim whitespace
            pattern="${pattern#"${pattern%%[![:space:]]*}"}"
            pattern="${pattern%"${pattern##*[![:space:]]}"}"
            echo "$pattern"
            return
        fi
    done < "$config_file"
}

# Convert path to local override path using specified pattern
# Used by the 'add' command to generate default override filenames
# e.g., get_local_path "AGENTS.md" ".override" -> AGENTS.override.md
get_local_path() {
    local path="$1"
    local pattern="${2:-.local}"
    local dir basename ext

    # Remove leading dot from pattern for insertion
    local pattern_infix="${pattern#.}"

    dir="$(dirname "$path")"
    basename="$(basename "$path")"

    if [[ "$basename" == *.* ]]; then
        ext="${basename##*.}"
        basename="${basename%.*}"
        if [[ "$dir" == "." ]]; then
            echo "${basename}.${pattern_infix}.${ext}"
        else
            echo "${dir}/${basename}.${pattern_infix}.${ext}"
        fi
    else
        if [[ "$dir" == "." ]]; then
            echo "${basename}.${pattern_infix}"
        else
            echo "${dir}/${basename}.${pattern_infix}"
        fi
    fi
}

# Validate config file format
# Returns 0 if valid, 1 if invalid
validate_config() {
    local repo_root="$1"
    local config_file="$repo_root/.local-overrides.yaml"

    # Check if config exists
    if [[ ! -f "$config_file" ]]; then
        return 0  # No config is valid (nothing to do)
    fi

    # Check for required pattern field
    local pattern
    pattern="$(read_pattern "$repo_root")"
    if [[ -z "$pattern" ]]; then
        warn "Missing required 'pattern:' field in .local-overrides.yaml"
        echo "  Add a pattern field at the top of your config:" >&2
        echo "    pattern: \".local\"" >&2
        return 1
    fi

    # Check for duplicate target files
    local seen_targets=""
    local entry target override

    while IFS= read -r entry || [[ -n "$entry" ]]; do
        [[ -z "$entry" ]] && continue
        target="${entry%%|*}"

        # Check if target was already seen
        if echo "$seen_targets" | grep -qxF "$target"; then
            die "Duplicate target file '$target' in config - each file can only appear in one 'replaces:' list"
        fi
        seen_targets="$seen_targets
$target"
    done < <(read_config "$repo_root")

    return 0
}

# Normalize a path to be relative to repo root
normalize_path() {
    local path="$1"
    local repo_root
    repo_root="$(get_repo_root)"

    # If path is absolute, make it relative to repo root
    if [[ "$path" == /* ]]; then
        path="${path#$repo_root/}"
    fi

    # Remove leading ./ if present
    path="${path#./}"

    echo "$path"
}

# Read config file and output list of target|override pairs
# Output format: target|override (one line per target file)
#
# Example config:
#   files:
#     - override: AGENTS.local.md
#       replaces:
#         - AGENTS.md
#         - CLAUDE.md
#
# Example output:
#   AGENTS.md|AGENTS.local.md
#   CLAUDE.md|AGENTS.local.md
#
read_config() {
    local repo_root="$1"
    local config_file="$repo_root/.local-overrides.yaml"

    [[ -f "$config_file" ]] || return 0

    local in_files_section=false
    local in_replaces_section=false
    local current_override=""
    local line

    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip empty lines and comments
        [[ -z "$line" || "$line" == \#* ]] && continue

        # Check for files: section start
        if [[ "$line" =~ ^files:[[:space:]]*$ ]]; then
            in_files_section=true
            in_replaces_section=false
            continue
        fi

        # Skip pattern: line
        if [[ "$line" =~ ^pattern: ]]; then
            continue
        fi

        # Stop if we hit another top-level key (non-indented, ends with :)
        if [[ "$line" =~ ^[a-z_]+:[[:space:]]*$ && ! "$line" =~ ^[[:space:]] ]]; then
            in_files_section=false
            in_replaces_section=false
            continue
        fi

        [[ "$in_files_section" != true ]] && continue

        # Handle override: line "  - override: AGENTS.local.md"
        if [[ "$line" =~ ^[[:space:]]*-[[:space:]]+override:[[:space:]]+(.+)$ ]]; then
            current_override="${BASH_REMATCH[1]}"
            # Clean up quotes and whitespace
            current_override="${current_override#\"}"
            current_override="${current_override%\"}"
            current_override="${current_override#\'}"
            current_override="${current_override%\'}"
            current_override="${current_override#"${current_override%%[![:space:]]*}"}"
            current_override="${current_override%"${current_override##*[![:space:]]}"}"
            in_replaces_section=false
            continue
        fi

        # Handle replaces: section start
        if [[ -n "$current_override" && "$line" =~ ^[[:space:]]+replaces:[[:space:]]*$ ]]; then
            in_replaces_section=true
            continue
        fi

        # Handle target files in replaces section "      - AGENTS.md"
        if [[ "$in_replaces_section" == true && "$line" =~ ^[[:space:]]+-[[:space:]]+(.+)$ ]]; then
            local target="${BASH_REMATCH[1]}"
            # Clean up quotes and whitespace
            target="${target#\"}"
            target="${target%\"}"
            target="${target#\'}"
            target="${target%\'}"
            target="${target#"${target%%[![:space:]]*}"}"
            target="${target%"${target##*[![:space:]]}"}"
            [[ -n "$target" ]] && echo "${target}|${current_override}"
            continue
        fi

        # If we encounter a new list item without replaces, reset state
        if [[ "$line" =~ ^[[:space:]]*-[[:space:]] ]]; then
            in_replaces_section=false
            current_override=""
        fi
    done < "$config_file"
}

# Check if file is in config and get its override path
# Returns 0 if found, 1 if not found
# If found, outputs "override_path" to stdout
get_override_for_target() {
    local target_path="$1"
    local repo_root="$2"

    local entry target override
    while IFS= read -r entry || [[ -n "$entry" ]]; do
        [[ -z "$entry" ]] && continue
        target="${entry%%|*}"
        override="${entry#*|}"
        if [[ "$target" == "$target_path" ]]; then
            echo "$override"
            return 0
        fi
    done < <(read_config "$repo_root")

    return 1
}

# Get all targets for a specific override file
get_targets_for_override() {
    local repo_root="$1"
    local override_file="$2"

    local entry target override
    while IFS= read -r entry || [[ -n "$entry" ]]; do
        [[ -z "$entry" ]] && continue
        target="${entry%%|*}"
        override="${entry#*|}"
        if [[ "$override" == "$override_file" ]]; then
            echo "$target"
        fi
    done < <(read_config "$repo_root")
}

# Get unique override files from config
get_override_files() {
    local repo_root="$1"
    local seen=""

    local entry override
    while IFS= read -r entry || [[ -n "$entry" ]]; do
        [[ -z "$entry" ]] && continue
        override="${entry#*|}"
        [[ -z "$override" ]] && continue

        if ! echo "$seen" | grep -qxF "$override"; then
            echo "$override"
            seen="$seen
$override"
        fi
    done < <(read_config "$repo_root")
}

#------------------------------------------------------------------------------
# Commands
#------------------------------------------------------------------------------

cmd_add() {
    local path="${1:-}"

    if [[ -z "$path" ]]; then
        die "Usage: git-local-override add <path>"
    fi

    local repo_root
    repo_root="$(get_repo_root)"
    path="$(normalize_path "$path")"

    local full_path="$repo_root/$path"

    # Check if file exists
    if [[ ! -f "$full_path" ]]; then
        die "File does not exist: $path"
    fi

    # Read pattern
    local pattern
    pattern="$(read_pattern "$repo_root")"
    [[ -z "$pattern" ]] && pattern=".local"

    # Check if file is already in config
    local override_path
    local in_config=false
    if override_path=$(get_override_for_target "$path" "$repo_root"); then
        in_config=true
    else
        # Generate default override filename using pattern
        override_path="$(get_local_path "$path" "$pattern")"
    fi

    local full_override_path="$repo_root/$override_path"

    # Create the override file if it doesn't exist
    if [[ ! -f "$full_override_path" ]]; then
        # Ensure parent directory exists
        mkdir -p "$(dirname "$full_override_path")"
        cp "$full_path" "$full_override_path"
        success "Created override file: $override_path"
    else
        info "Override file already exists: $override_path"
    fi

    if [[ "$in_config" == true ]]; then
        # Apply the override
        cp "$full_override_path" "$full_path"
        success "Override active for: $path"
        echo "  Edit your override file: $override_path"
    else
        info "To enable this override, add to .local-overrides.yaml:"
        echo ""
        echo "  - override: $override_path"
        echo "    replaces:"
        echo "      - $path"
        echo ""
    fi
}

cmd_remove() {
    local path="${1:-}"
    local delete_file=false

    if [[ "$path" == "--delete" || "$path" == "-d" ]]; then
        delete_file=true
        path="${2:-}"
    fi

    if [[ -z "$path" ]]; then
        die "Usage: git-local-override remove [-d|--delete] <path>"
    fi

    local repo_root
    repo_root="$(get_repo_root)"
    path="$(normalize_path "$path")"

    # Get override path from config
    local override_path
    if ! override_path=$(get_override_for_target "$path" "$repo_root"); then
        die "'$path' is not in .local-overrides.yaml"
    fi

    local full_path="$repo_root/$path"
    local full_override_path="$repo_root/$override_path"

    # Restore original content from git
    if git -C "$repo_root" ls-files --error-unmatch "$path" &>/dev/null; then
        git -C "$repo_root" checkout HEAD -- "$path" 2>/dev/null || true
        info "Restored original content: $path"
    fi

    # Optionally delete the override file
    if [[ "$delete_file" == true && -f "$full_override_path" ]]; then
        rm "$full_override_path"
        info "Deleted override file: $override_path"
    elif [[ -f "$full_override_path" ]]; then
        info "Override file preserved: $override_path"
        echo "  Use -d/--delete to also remove the override file"
    fi

    info "Remember to remove '$path' from the 'replaces:' list in .local-overrides.yaml"
    success "Override removed for: $path"
}

cmd_list() {
    local repo_root
    repo_root="$(get_repo_root)"

    # Check for config file
    if [[ ! -f "$repo_root/.local-overrides.yaml" ]]; then
        echo "No .local-overrides.yaml found in repository"
        echo ""
        echo "Create one with: git-local-override init-config"
        return 0
    fi

    # Validate config
    if ! validate_config "$repo_root"; then
        return 1
    fi

    local pattern
    pattern="$(read_pattern "$repo_root")"

    echo "Configured overrides (pattern: $pattern):"
    echo ""

    local total_overrides=0
    local active_overrides=0

    # Group by override file
    local override_file
    while IFS= read -r override_file || [[ -n "$override_file" ]]; do
        [[ -z "$override_file" ]] && continue

        local status=""
        if [[ -f "$repo_root/$override_file" ]]; then
            status="${GREEN}[active]${NC}"
            ((active_overrides++)) || true
        else
            status="${YELLOW}[no file]${NC}"
        fi

        # Get all targets for this override
        local targets=""
        local target_count=0
        local target
        while IFS= read -r target || [[ -n "$target" ]]; do
            [[ -z "$target" ]] && continue
            if [[ -n "$targets" ]]; then
                targets="$targets, $target"
            else
                targets="$target"
            fi
            ((target_count++)) || true
        done < <(get_targets_for_override "$repo_root" "$override_file")

        ((total_overrides += target_count)) || true

        echo -e "  ${BLUE}$override_file${NC} $status"
        echo "    -> $targets"
        echo ""
    done < <(get_override_files "$repo_root")

    echo "Total: $total_overrides target(s), $active_overrides active override file(s)"
}

cmd_status() {
    local repo_root
    repo_root="$(get_repo_root)"

    echo "Local Override Status"
    echo "====================="
    echo ""
    echo "Repository: $repo_root"
    echo ""

    # Check for config file
    if [[ -f "$repo_root/.local-overrides.yaml" ]]; then
        echo -e "Config:     ${GREEN}.local-overrides.yaml${NC}"
        local pattern
        pattern="$(read_pattern "$repo_root")"
        if [[ -n "$pattern" ]]; then
            echo -e "Pattern:    ${GREEN}$pattern${NC}"
        else
            echo -e "Pattern:    ${YELLOW}not set (required)${NC}"
        fi
    else
        echo -e "Config:     ${YELLOW}not found${NC}"
        echo ""
        echo "Create config with: git-local-override init-config"
        return 0
    fi

    # Check if hooks are installed
    local hooks_installed=true
    local hook_type
    for hook_type in post-checkout pre-commit post-commit; do
        local hook_file="$repo_root/.git/hooks/$hook_type"
        if [[ ! -f "$hook_file" ]] || ! grep -q "local-override" "$hook_file" 2>/dev/null; then
            hooks_installed=false
            break
        fi
    done

    if [[ "$hooks_installed" == true ]]; then
        echo -e "Hooks:      ${GREEN}installed${NC}"
    else
        echo -e "Hooks:      ${YELLOW}not installed${NC}"
        echo ""
        echo "Install hooks with one of:"
        echo "  - pre-commit install --hook-type pre-commit --hook-type post-commit --hook-type post-checkout"
        echo "  - curl -fsSL https://raw.githubusercontent.com/jonathanabila/git-override/main/scripts/install.sh | bash"
    fi

    echo ""
    cmd_list
}

cmd_apply() {
    local repo_root
    repo_root="$(get_repo_root)"

    if [[ ! -f "$repo_root/.local-overrides.yaml" ]]; then
        die "No .local-overrides.yaml found"
    fi

    # Validate config
    if ! validate_config "$repo_root"; then
        exit 1
    fi

    info "Applying all overrides..."

    local count=0
    local entry target override
    while IFS= read -r entry || [[ -n "$entry" ]]; do
        [[ -z "$entry" ]] && continue

        target="${entry%%|*}"
        override="${entry#*|}"

        local full_target="$repo_root/$target"
        local full_override="$repo_root/$override"

        if [[ -f "$full_override" && -f "$full_target" ]]; then
            cp "$full_override" "$full_target"
            # Mark as skip-worktree so git status doesn't show the change
            git -C "$repo_root" update-index --skip-worktree "$target" 2>/dev/null || true
            echo "  Applied: $target <- $override"
            ((count++)) || true
        fi
    done < <(read_config "$repo_root")

    success "Applied $count override(s)"
}

cmd_restore() {
    local repo_root
    repo_root="$(get_repo_root)"

    if [[ ! -f "$repo_root/.local-overrides.yaml" ]]; then
        die "No .local-overrides.yaml found"
    fi

    # Validate config
    if ! validate_config "$repo_root"; then
        exit 1
    fi

    info "Restoring all originals..."

    local count=0
    local entry target override
    while IFS= read -r entry || [[ -n "$entry" ]]; do
        [[ -z "$entry" ]] && continue

        target="${entry%%|*}"
        override="${entry#*|}"

        # Only restore if there's an override file
        if [[ -f "$repo_root/$override" ]]; then
            if git -C "$repo_root" ls-files --error-unmatch "$target" &>/dev/null; then
                # Clear skip-worktree so git can see the file
                git -C "$repo_root" update-index --no-skip-worktree "$target" 2>/dev/null || true
                git -C "$repo_root" checkout HEAD -- "$target" 2>/dev/null || true
                echo "  Restored: $target"
                ((count++)) || true
            fi
        fi
    done < <(read_config "$repo_root")

    success "Restored $count file(s)"
}

cmd_init_config() {
    local repo_root
    repo_root="$(get_repo_root)"

    local config_file="$repo_root/.local-overrides.yaml"

    if [[ -f "$config_file" ]]; then
        info "Config file already exists: $config_file"
        return 0
    fi

    cat > "$config_file" << 'EOF'
# Local Override Configuration
#
# pattern: Required. Used by CLI to generate default override filenames.
#          Example: ".local" means CLAUDE.md -> CLAUDE.local.md
#
# files: List of override entries. Each entry has:
#        - override: The local file that contains your custom content
#        - replaces: List of tracked files this override replaces
#
# One override file can replace multiple tracked files (1:many).

pattern: ".local"
files:
  # Example: CLAUDE.local.md replaces CLAUDE.md
  - override: CLAUDE.local.md
    replaces:
      - CLAUDE.md

  # Example: One file replacing multiple targets
  # - override: AGENTS.local.md
  #   replaces:
  #     - AGENTS.md
  #     - CLAUDE.md
EOF

    success "Created: $config_file"
    echo ""
    echo "Edit this file to configure your overrides."
    echo "The 'pattern:' field is required."
}

cmd_help() {
    cat << 'EOF'
git-local-override - Manage local file overrides

USAGE:
    git-local-override <command> [options]

COMMANDS:
    add <path>              Create a local override file for a tracked file
    remove [-d] <path>      Remove an override (-d to delete override file too)
    list                    List all configured overrides
    status                  Show detailed status
    apply                   Manually apply all overrides
    restore                 Manually restore all originals from git
    init-config             Create a .local-overrides.yaml template
    help                    Show this help message

EXAMPLES:
    # Initialize config
    git-local-override init-config

    # Create a local override for CLAUDE.md
    git-local-override add CLAUDE.md

    # Edit your local version
    vim CLAUDE.local.md

    # See what's configured
    git-local-override list

    # Manually apply overrides (hooks do this automatically)
    git-local-override apply

    # Restore originals (hooks do this before commits)
    git-local-override restore

CONFIG FORMAT:
    The .local-overrides.yaml uses override/replaces format:

      pattern: ".local"         # Required: used to generate override names
      files:
        - override: CLAUDE.local.md
          replaces:
            - CLAUDE.md

        # One override can replace multiple files:
        - override: AGENTS.local.md
          replaces:
            - AGENTS.md
            - CLAUDE.md

HOW IT WORKS:
    1. Repository maintainer creates .local-overrides.yaml
    2. Users create override files (e.g., CLAUDE.local.md)
    3. Git hooks automatically:
       - Show local content in working tree
       - Commit original content
       - Restore local content after commits

    With multi-target overrides, one file can replace many:
    - AGENTS.local.md can replace both AGENTS.md and CLAUDE.md
    - When committing, all targets are restored together

INSTALLATION:
    Hooks can be installed via:

    Pre-commit (recommended for teams):
      Add to .pre-commit-config.yaml:
        repos:
          - repo: https://github.com/jonathanabila/git-override
            rev: v0.1.0  # Use latest version
            hooks:
              - id: local-override-pre-commit
              - id: local-override-post-commit
              - id: local-override-post-checkout

      Then run:
        pre-commit install --hook-type pre-commit --hook-type post-commit --hook-type post-checkout

    Standalone:
      curl -fsSL https://raw.githubusercontent.com/jonathanabila/git-override/main/scripts/install.sh | bash
EOF
}

#------------------------------------------------------------------------------
# Main
#------------------------------------------------------------------------------

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        add)            cmd_add "$@" ;;
        remove|rm)      cmd_remove "$@" ;;
        list|ls)        cmd_list "$@" ;;
        status)         cmd_status "$@" ;;
        apply)          cmd_apply "$@" ;;
        restore)        cmd_restore "$@" ;;
        init-config)    cmd_init_config "$@" ;;
        help|--help|-h) cmd_help ;;
        *)              die "Unknown command: $cmd. Run 'git-local-override help' for usage." ;;
    esac
}

main "$@"
